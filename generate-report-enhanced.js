// Function to send email with the overnight report - Updated Styling
async function sendOvernightReportEmail(reportContent, dateStr) {
    if (!GMAIL_USER || !GMAIL_PASSWORD || !WORK_EMAIL_LIST) {
        console.log('‚ö†Ô∏è  Email credentials not provided, skipping email send');
        return;
    }
    
    try {
        console.log('üìß Setting up email transport for morning market report...');
        
        const transport = nodemailer.createTransport({
            service: 'gmail',
            auth: {
                user: GMAIL_USER,
                pass: GMAIL_PASSWORD
            }
        });
        
        const timing = getMarketTimingInfo();
        
        // Updated styling with dark grey headers, black text, and soft gold underlines
        const emailHtml = reportContent
            .replace(/^# (.*$)/gm, '<h1 style="color: #2c2c2c; border-bottom: 3px solid #d4af37; padding-bottom: 12px; margin-bottom: 20px; font-weight: bold;">$1</h1>')
            .replace(/^## (.*$)/gm, '<h2 style="color: #2c2c2c; margin-top: 25px; border-bottom: 2px solid #d4af37; padding-bottom: 8px; font-weight: bold;">$1</h2>')
            .replace(/^\*\*(.*?)\*\*/gm, '<h3 style="color: #2c2c2c; margin-top: 30px; margin-bottom: 15px; border-bottom: 1px solid #d4af37; padding-bottom: 6px; font-weight: bold;">$1</h3>')
            .replace(/^\*(.*$)/gm, '<p style="font-style: italic; color: #000000; border-bottom: 1px dotted #d4af37; padding-bottom: 4px; margin-bottom: 8px;">$1</p>')
            .replace(/^([^<\n].*$)/gm, '<p style="line-height: 1.6; margin-bottom: 12px; color: #000000; padding-bottom: 2px;">$1</p>')
            .replace(/\n\n/g, '<br><br>')
            .replace(/\n/g, '<br>');
        
        const emailContent = `
        <div style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 900px; margin: 0 auto; background-color: white; padding: 20px;">
            <div style="background-color: white; padding: 35px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 1px solid #e0e0e0;">
                ${emailHtml}
                
                <div style="margin-top: 35px; padding: 25px; background-color: white; color: #000000; border-radius: 8px; border: 2px solid #d4af37; border-bottom: 4px solid #d4af37;">
                    <p style="margin: 0; font-weight: bold; color: #2c2c2c; border-bottom: 1px solid #d4af37; padding-bottom: 8px; margin-bottom: 10px;">MORNING MARKET INTELLIGENCE</p>
                    <p style="margin: 5px 0 0 0; font-size: 14px; color: #000000;">Last Close: ${timing.lastClose} ‚Ä¢ Next Open: ${timing.nextOpen} ‚Ä¢ Generated by Claude AI</p>
                </div>
            </div>
        </div>`;
        
        const mailOptions = {
            from: GMAIL_USER,
            to: WORK_EMAIL_LIST.split(',').map(email => email.trim()),
            subject: `Morning Market Report - ${dateStr} - Close to Open Analysis`,
            html: emailContent,
            text: reportContent,
            priority: 'high'
        };
        
        console.log('üì§ Sending morning market report...');
        const info = await transport.sendMail(mailOptions);
        console.log('‚úÖ Morning report sent successfully:', info.messageId);
        console.log('üìß Recipients:', WORK_EMAIL_LIST);
        
    } catch (error) {
        console.error('‚ùå Failed to send overnight report:', error.response?.data || error.message);
        console.log('üìù Report was still saved to file successfully');
    }
}

// Alternative comprehensive styling function for all text elements
function applyDarkGreyGoldStyling() {
    return {
        // Main container
        container: "font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 900px; margin: 0 auto; background-color: white; padding: 20px;",
        
        // Content wrapper
        wrapper: "background-color: white; padding: 35px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 1px solid #e0e0e0;",
        
        // Headers
        h1: "color: #2c2c2c; border-bottom: 3px solid #d4af37; padding-bottom: 12px; margin-bottom: 20px; font-weight: bold; font-size: 24px;",
        h2: "color: #2c2c2c; margin-top: 25px; border-bottom: 2px solid #d4af37; padding-bottom: 8px; font-weight: bold; font-size: 20px;",
        h3: "color: #2c2c2c; margin-top: 30px; margin-bottom: 15px; border-bottom: 1px solid #d4af37; padding-bottom: 6px; font-weight: bold; font-size: 18px;",
        
        // Paragraphs
        paragraph: "line-height: 1.6; margin-bottom: 12px; color: #000000; padding-bottom: 2px;",
        italic: "font-style: italic; color: #000000; border-bottom: 1px dotted #d4af37; padding-bottom: 4px; margin-bottom: 8px;",
        
        // Special elements
        highlight: "background-color: white; color: #000000; border-left: 4px solid #d4af37; padding: 12px; margin: 15px 0;",
        quote: "color: #000000; border-left: 3px solid #d4af37; padding-left: 15px; font-style: italic; margin: 15px 0;",
        
        // Lists
        listItem: "color: #000000; margin-bottom: 8px; border-bottom: 1px dotted #d4af37; padding-bottom: 4px;",
        
        // Footer
        footer: "margin-top: 35px; padding: 25px; background-color: white; color: #000000; border-radius: 8px; border: 2px solid #d4af37; border-bottom: 4px solid #d4af37;",
        footerTitle: "margin: 0; font-weight: bold; color: #2c2c2c; border-bottom: 1px solid #d4af37; padding-bottom: 8px; margin-bottom: 10px;",
        footerText: "margin: 5px 0 0 0; font-size: 14px; color: #000000;",
        
        // Tables (if needed)
        table: "width: 100%; border-collapse: collapse; margin: 15px 0;",
        tableHeader: "background-color: white; color: #2c2c2c; border-bottom: 2px solid #d4af37; padding: 12px; text-align: left;",
        tableCell: "color: #000000; border-bottom: 1px solid #d4af37; padding: 10px;",
        
        // Links
        link: "color: #000000; text-decoration: underline; text-decoration-color: #d4af37; text-decoration-thickness: 2px;",
        
        // Buttons (if needed)
        button: "background-color: #d4af37; color: #000000; border: none; padding: 12px 24px; border-radius: 6px; font-weight: bold; text-decoration: none; display: inline-block; margin: 10px 0;"
    };
}

// Enhanced regex replacements for comprehensive styling
function formatContentWithDarkGreyGold(content) {
    const styles = applyDarkGreyGoldStyling();
    
    return content
        // Main headers
        .replace(/^# (.*$)/gm, `<h1 style="${styles.h1}">$1</h1>`)
        .replace(/^## (.*$)/gm, `<h2 style="${styles.h2}">$1</h2>`)
        .replace(/^### (.*$)/gm, `<h3 style="${styles.h3}">$1</h3>`)
        
        // Bold text (becomes h3 style)
        .replace(/^\*\*(.*?)\*\*/gm, `<h3 style="${styles.h3}">$1</h3>`)
        
        // Italic text
        .replace(/^\*(.*$)/gm, `<p style="${styles.italic}">$1</p>`)
        
        // Links
        .replace(/\[([^\]]+)\]\(([^)]+)\)/g, `<a href="$2" style="${styles.link}">$1</a>`)
        
        // List items
        .replace(/^- (.*$)/gm, `<p style="${styles.listItem}">‚Ä¢ $1</p>`)
        .replace(/^\d+\. (.*$)/gm, `<p style="${styles.listItem}">$1</p>`)
        
        // Regular paragraphs
        .replace(/^([^<#\*\-\d\n].*$)/gm, `<p style="${styles.paragraph}">$1</p>`)
        
        // Line breaks
        .replace(/\n\n/g, '<br><br>')
        .replace(/\n/g, '<br>');
}
