name: Daily Market Summary

on:
  workflow_dispatch:
  schedule:
    - cron: '0 11 * * 1-5'

jobs:
  generate-report:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install packages
      run: pip install anthropic yfinance pandas tabulate

    - name: Fetch market data
      run: python scripts/fetch_data.py
        
    - name: Generate enhanced report
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: python scripts/generate_report.py
        
    - name: Commit report
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add reports/
        git commit -m "Enhanced market summary - $(date '+%Y-%m-%d')" || echo "Nothing to commit"
        git push

    - name: Create GitHub issue
      if: success()
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          try {
            const info = JSON.parse(fs.readFileSync('report_info.json', 'utf8'));
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Daily Market Summary - ${new Date().toLocaleDateString()}`,
              body: `Your enhanced market report is ready!\n\nInstruments analyzed: ${info.count}\n\nView report: https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/${info.filename}`
            });
            console.log('Issue created successfully');
          } catch (error) {
            console.log('Error:', error.message);
          }
