name: Verified Daily Market Report

on:
  schedule:
    # Runs at 12:00 PM UTC daily
    - cron: '0 12 * * *'
  workflow_dispatch: # Allows manual triggering

jobs:
  generate-verified-report:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: |
        echo "üì¶ Installing required dependencies..."
        npm install axios
        npm install nodemailer
        echo "‚úÖ Core dependencies installed"
        
    - name: Verify environment
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        ALPHA_VANTAGE_API_KEY: ${{ secrets.ALPHA_VANTAGE_API_KEY }}
        FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
        POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
        GMAIL_USER: ${{ secrets.GMAIL_USER }}
        GMAIL_PASSWORD: ${{ secrets.GMAIL_PASSWORD }}
        WORK_EMAIL_LIST: ${{ secrets.WORK_EMAIL_LIST }}
      run: |
        echo "üîç Verifying environment variables..."
        echo "ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY && '‚úÖ Present' || '‚ùå Missing' }}"
        echo "ALPHA_VANTAGE_API_KEY: ${{ secrets.ALPHA_VANTAGE_API_KEY && '‚úÖ Present' || '‚ö†Ô∏è Optional - Missing' }}"
        echo "FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY && '‚úÖ Present' || '‚ö†Ô∏è Optional - Missing' }}"
        echo "POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY && '‚úÖ Present' || '‚ö†Ô∏è Optional - Missing' }}"
        echo "GMAIL_USER: ${{ secrets.GMAIL_USER && '‚úÖ Present' || '‚ùå Missing' }}"
        echo "GMAIL_PASSWORD: ${{ secrets.GMAIL_PASSWORD && '‚úÖ Present' || '‚ùå Missing' }}"
        echo "WORK_EMAIL_LIST: ${{ secrets.WORK_EMAIL_LIST && '‚úÖ Present' || '‚ùå Missing' }}"
        
    - name: Generate Verified Market Report
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        ALPHA_VANTAGE_API_KEY: ${{ secrets.ALPHA_VANTAGE_API_KEY }}
        FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
        POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
        GMAIL_USER: ${{ secrets.GMAIL_USER }}
        GMAIL_PASSWORD: ${{ secrets.GMAIL_PASSWORD }}
        WORK_EMAIL_LIST: ${{ secrets.WORK_EMAIL_LIST }}
      run: |
        echo "üöÄ Starting verified market report generation..."
        node generate-verified-report.js
        echo "‚úÖ Report generation completed"
        
    - name: Verify report generation
      run: |
        echo "üîç Verifying generated files..."
        if [ -d "reports" ]; then
          echo "‚úÖ Reports directory exists"
          ls -la reports/
          
          # Check if today's report was generated
          TODAY=$(date +'%Y-%m-%d')
          if [ -f "reports/verified-market-report-${TODAY}.md" ]; then
            echo "‚úÖ Today's report generated: verified-market-report-${TODAY}.md"
            echo "üìä Report size: $(wc -c < reports/verified-market-report-${TODAY}.md) bytes"
          else
            echo "‚ö†Ô∏è Today's report not found"
          fi
          
          if [ -f "reports/latest-verified-report.md" ]; then
            echo "‚úÖ Latest report link created"
          fi
          
          if [ -f "reports/verification-data-${TODAY}.json" ]; then
            echo "‚úÖ Verification data saved"
          fi
        else
          echo "‚ùå Reports directory not found"
          exit 1
        fi
        
    - name: Commit and push reports
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action Bot"
        
        # Add all report files
        git add reports/
        
        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "üìù No new reports to commit"
        else
          TODAY=$(date +'%Y-%m-%d')
          git commit -m "üìà Verified daily market report - ${TODAY}

          Generated: $(date +'%Y-%m-%d %H:%M:%S UTC')
          Status: Accuracy verified and validated
          Files: Report, verification data, and latest link
          
          Automated by GitHub Actions ü§ñ"
          
          echo "üì§ Pushing verified report to repository..."
          git push
          echo "‚úÖ Report successfully committed and pushed"
        fi
        
    - name: Report generation summary
      if: always()
      run: |
        echo "
        üìä === MARKET REPORT GENERATION SUMMARY ===
        üïê Time: $(date +'%Y-%m-%d %H:%M:%S UTC')
        üìà Report Type: Verified Daily Market Report
        üîç Accuracy: Enhanced with fact-checking
        üìß Email: Automated delivery
        üìÅ Storage: GitHub repository
        ü§ñ Automation: GitHub Actions
        
        ‚úÖ Process completed successfully!
        "

  # Optional: Send notification on failure
  notify-on-failure:
    runs-on: ubuntu-latest
    needs: generate-verified-report
    if: failure()
    
    steps:
    - name: Report failure
      run: |
        echo "‚ùå Market report generation failed"
        echo "‚è∞ Failure time: $(date +'%Y-%m-%d %H:%M:%S UTC')"
        echo "üîç Check the logs above for detailed error information"
        echo "üìß Consider setting up email notifications for failures"
